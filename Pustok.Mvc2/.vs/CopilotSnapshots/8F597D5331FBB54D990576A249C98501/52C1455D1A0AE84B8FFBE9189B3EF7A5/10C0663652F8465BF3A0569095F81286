using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Pustok.Mvc2.Data;
using Pustok.Mvc2.Models;

namespace Pustok.Mvc2.Areas.Manage.Controllers;
[Area("Manage")]

public class AuthorController(AppDbContext appDbContext) : Controller
{
    public IActionResult Index()
    {
        var authors = appDbContext.Authors.Include(x => x.Books).
            ToList();
        return View(authors);
    }
    public IActionResult Delete(int id)
    {
        var author = appDbContext.Authors.FirstOrDefault(x => x.Id == id);
        if (author == null) return NotFound();
        appDbContext.Authors.Remove(author);
        appDbContext.SaveChanges();
        return Ok();
    }
    public IActionResult Create()
    {
        return View();
    }
    [HttpPost]
    public IActionResult Create(Author author)
    {
        if (!ModelState.IsValid)
            return View();
        if(appDbContext.Authors.Any(x => x.FullName == author.FullName))
        {
            ModelState.AddModelError("FullName", "This author already exists");
            return View();
        }
        appDbContext.Authors.Add(author);
        appDbContext.SaveChanges();

        return RedirectToAction("Index");
    }
    public IActionResult Update(int id)
    {
        var author = appDbContext.Authors.FirstOrDefault(x => x.Id == id);
        if (author == null) return NotFound();
        return View(author);
    }
    [HttpPost]
    public IActionResult Update(Author author)
    {
        if (!ModelState.IsValid)
            return View();
        var existAuthor = appDbContext.Authors.FirstOrDefault(x => x.Id == author.Id);
        if (existAuthor == null) return NotFound();
        if (appDbContext.Authors.Any(x => x.FullName == author.FullName && x.Id != author.Id))
        {
            ModelState.AddModelError("FullName", "This author already exists");
            return View();
        }
        existAuthor.FullName = author.FullName;
        appDbContext.SaveChanges();
        return RedirectToAction("Index");
    }
}
