using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Pustok.Mvc2.Data;
using Pustok.Mvc2.ViewModels;

namespace Pustok.Mvc2.Controllers
{
    public class BooksController(AppDbContext appDbContext) : Controller
    {
        public IActionResult Details(int id)
        {
            var bookDetailVm = appDbContext.Books
                .Include(x => x.BookImages)
                .Include(x => x.Author)
                .Include(x => x.BookTags)
                    .ThenInclude(bt => bt.Tag)
                .Where(b => b.Id == id)
                .Select(x => new BookDetailVm
                {
                    Name = x.Name,
                    Price = x.Price,
                    Code = x.Code,
                    InStock = x.InStock,
                    IsFeatured = x.IsFeatured,
                    IsNew = x.IsNew,
                    Description = x.Description,
                    DiscountPercent = x.DiscountPercent,
                    MainImageUrl = x.MainImageUrl,
                    HoverImageUrl = x.HoverImageUrl,
                    AuthorId = x.AuthorId,
                    AuthorName = x.Author.FullName,
                    TagNames = x.BookTags.Select(bt => bt.Tag.Name).ToList(),
                    BookImageUrls = x.BookImages.Select(bi => bi.ImageUrl).ToList()
                })
                .FirstOrDefault();
                
            if (bookDetailVm == null)
                return NotFound();

            return Ok(bookDetailVm);
        }

        public IActionResult BookModal(int id)
        {
            var book = appDbContext.Books
                .Include(x => x.BookImages)
                .Include(x => x.Author)
                .Include(x => x.BookTags)
                    .ThenInclude(bt => bt.Tag)
                .FirstOrDefault(b => b.Id == id);
            if (book == null)
                return NotFound();
            return PartialView("_BookModalPartial", book);
        }

    }

}
